<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Actividad Criminal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles_ajustado.css">
    <link rel="stylesheet" href="fix-producto-campo.css">
    <link rel="stylesheet" href="fix-tabla-historial.css">
    <link rel="stylesheet" href="tabla-fix.css">
    <link rel="stylesheet" href="tabla-delincuentes-fix.css">
    <link rel="stylesheet" href="paginacion.css">
    <link rel="stylesheet" href="modal-delincuentes.css">
    <link rel="stylesheet" href="render-layout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="js/session-check.js"></script>
    
    <script>
        window.jspdf = window.jspdf || {};
        // Asegurarnos de que jsPDF esté disponible globalmente
        window.initJsPDF = function() {
            console.log('Inicializando jsPDF y plugins...');
            // Verificar que todo esté cargado correctamente
            if (window.jspdf && window.jspdf.jsPDF) {
                console.log('jsPDF está disponible correctamente');
            } else {
                console.error('Error: jsPDF no está disponible correctamente');
            }
        };
    </script>
    
    </head>
<body>
    <div class="admin-access">
        <button id="adminButton" class="btn btn-primary" onclick="window.location.href='admin.html'">
            <i class="fas fa-shield-alt"></i> Panel de Administración
        </button>
    </div>


    <div class="container">
        <div class="header">
            <h2>Registro de Actividad Criminal</h2>
            <div class="user-info-container"> <div class="user-info">
                    <span>Usuario: <strong id="usuarioInfo"></strong></span>
                    <button type="button" class="btn btn-sm btn-danger btn-cerrar-sesion" onclick="cerrarSesion()">Cerrar Sesión</button> </div>
            </div>
        </div>
        <form id="actividadCriminalForm">
            <table class="form-table">
                <tr>
                    <td>Empresa:</td>
                    <td>
                        <input type="text" id="empresa" name="empresa" required pattern="[A-Za-z0-9\s]+" 
                               title="Solo se permiten caracteres alfanuméricos">
                    </td>
                    <td><strong>Fecha:</strong></td>
                    <td>
                        <input type="text" id="fecha" name="fecha" value="26 de marzo de 2025" readonly class="form-control fecha-input input-fecha-delito" placeholder="DD/MM/AAAA" style="width: 100%; box-sizing: border-box;" required data-formateo-inicializado="true"> </td>
                </tr>
                <tr>
                    <td>Responsable de Seguridad:</td>
                    <td>
                        <input type="text" id="responsable" name="responsable" required>
                    </td>
                    <td>Trimestre:</td>
                    <td>
                        <select id="trimestre" name="trimestre" required>
                            <option value="Q1">1er Trimestre</option>
                            <option value="Q2">2do Trimestre</option>
                            <option value="Q3">3er Trimestre</option>
                            <option value="Q4">4to Trimestre</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Cédula:</td>
                    <td colspan="3">
                        <input type="text" id="cedula" name="cedula" required 
                               pattern="^([PE]|N|E)-?\d{1,2}-?\d{1,4}-?\d{1,5}$|^\d{1,2}-\d{1,4}-\d{1,5}$" 
                               title="Formato válido: P-00-0000-00000 o E-00-0000-00000 o N-00-0000-00000 o 00-0000-00000"
                               placeholder="Ej: P-00-0000-00000">
                    </td>
                </tr>
            </table>

            <div class="section-title">CASOS DELICTIVOS OCURRIDOS EN EL TRIMESTRE</div>
            
            <table id="tablaCasosDelictivos" class="table table-bordered">
                <thead>
                    <tr>
                        <th style="width: 120px;">Tipificación</th>
                        <th style="width: 120px;">Fecha</th>
                        <th style="width: 100px;">Cantidad</th>
                        <th style="width: 120px;">Cuantía (B/.)</th>
                        <th style="width: 100px;">Denuncias</th>
                        <th style="width: 150px;">Producto/Mercancía</th>
                        <th style="width: 200px;">Observaciones</th>
                        <th style="width: 80px;">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="width: 120px;">
                            <div class="tipificacion-container">
                                <span class="tipificacion-texto">Hurto</span>
                                <button type="button" class="btn btn-xs btn-primary tipificacion-selector-btn" style="padding: 2px 5px; font-size: 10px; margin-left: 5px;" onclick="abrirModalTipificacion(this)">...</button>
                                <input type="hidden" name="tipificacion[]" value="Hurto" class="tipificacion-input" required>
                            </div>
                        </td>
                        <td style="width: 120px;">
                            <input type="text" name="fecha[]" class="form-control fecha-input input-fecha-delito" placeholder="DD/MM/AAAA" style="width: 100%; box-sizing: border-box;" required>
                        </td>
                        <td style="width: 100px;">
                            <input type="number" min="0" name="cantidad[]" class="form-control cantidad-input" style="width: 100%;" required placeholder="0">
                        </td>
                        <td style="width: 120px;">
                            <input type="number" min="0" step="0.01" name="cuantia[]" class="form-control cuantia-input" style="width: 100%;" required placeholder="0.00">
                        </td>
                        <td style="width: 100px;">
                            <input type="number" min="0" name="denuncias[]" class="form-control denuncias-input" style="width: 100%;" required placeholder="0">
                        </td>
                        <td style="width: 150px;">
                            <input type="text" name="producto[]" class="form-control producto-input" style="width: 100%;" placeholder="Producto/Mercancía" required>
                        </td>
                        <td style="width: 200px;">
                            <input type="text" name="observaciones[]" class="form-control" style="width: 100%;" placeholder="Observaciones" required onchange="onObservacionCambio(this)"> <!-- input simple, sin desplegable -->
                        </td>
                        <td style="width: 80px; text-align: center;">
                            <div style="display: flex; justify-content: center; gap: 5px;">
                                <button type="button" class="btn btn-success btn-sm" title="Agregar" onclick="agregarFilaProductoSoloVisual()">+</button>
<button type="button" class="btn btn-danger btn-sm" title="Eliminar" onclick="eliminarFila(this)">X</button>
                            </div>
                        </td>
                    </tr>
                    <tr id="placeholder-casos" style="display:none;"> <td colspan="8" class="text-center-content placeholder-text">Agregue un caso delictivo usando el botón +</td> </tr>
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td></td>
                        <td id="totalCantidad" class="text-center-content">0</td>
                        <td id="totalCuantia" class="text-center-content">B/. 0.00</td>
                        <td id="totalDenuncias" class="text-center-content">0</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            
            <div id="reporte-perdidas-trimestrales-anchor"></div>

            <!-- Top 20 Productos y Mercancías Robadas -->
            <div class="section-title">Top 20 Productos y Mercancías Robadas</div>
            <div class="tabla-productos-container" style="overflow-x:auto; width:100%;">
                <table id="tablaProductos" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Producto/Mercancía</th>
                            <th>Cantidad Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 20 filas fijas para el Top 20 -->
                        <tr id="producto-row-1">
                            <td>1</td>
                            <td id="nombre-1"></td>
                            <td id="cantidad-1"></td>
                        </tr>
                        <tr id="producto-row-2">
                            <td>2</td>
                            <td id="nombre-2"></td>
                            <td id="cantidad-2"></td>
                        </tr>
                        <tr id="producto-row-3">
                            <td>3</td>
                            <td id="nombre-3"></td>
                            <td id="cantidad-3"></td>
                        </tr>
                        <tr id="producto-row-4">
                            <td>4</td>
                            <td id="nombre-4"></td>
                            <td id="cantidad-4"></td>
                        </tr>
                        <tr id="producto-row-5">
                            <td>5</td>
                            <td id="nombre-5"></td>
                            <td id="cantidad-5"></td>
                        </tr>
                        <tr id="producto-row-6">
                            <td>6</td>
                            <td id="nombre-6"></td>
                            <td id="cantidad-6"></td>
                        </tr>
                        <tr id="producto-row-7">
                            <td>7</td>
                            <td id="nombre-7"></td>
                            <td id="cantidad-7"></td>
                        </tr>
                        <tr id="producto-row-8">
                            <td>8</td>
                            <td id="nombre-8"></td>
                            <td id="cantidad-8"></td>
                        </tr>
                        <tr id="producto-row-9">
                            <td>9</td>
                            <td id="nombre-9"></td>
                            <td id="cantidad-9"></td>
                        </tr>
                        <tr id="producto-row-10">
                            <td>10</td>
                            <td id="nombre-10"></td>
                            <td id="cantidad-10"></td>
                        </tr>
                        <tr id="producto-row-11">
                            <td>11</td>
                            <td id="nombre-11"></td>
                            <td id="cantidad-11"></td>
                        </tr>
                        <tr id="producto-row-12">
                            <td>12</td>
                            <td id="nombre-12"></td>
                            <td id="cantidad-12"></td>
                        </tr>
                        <tr id="producto-row-13">
                            <td>13</td>
                            <td id="nombre-13"></td>
                            <td id="cantidad-13"></td>
                        </tr>
                        <tr id="producto-row-14">
                            <td>14</td>
                            <td id="nombre-14"></td>
                            <td id="cantidad-14"></td>
                        </tr>
                        <tr id="producto-row-15">
                            <td>15</td>
                            <td id="nombre-15"></td>
                            <td id="cantidad-15"></td>
                        </tr>
                        <tr id="producto-row-16">
                            <td>16</td>
                            <td id="nombre-16"></td>
                            <td id="cantidad-16"></td>
                        </tr>
                        <tr id="producto-row-17">
                            <td>17</td>
                            <td id="nombre-17"></td>
                            <td id="cantidad-17"></td>
                        </tr>
                        <tr id="producto-row-18">
                            <td>18</td>
                            <td id="nombre-18"></td>
                            <td id="cantidad-18"></td>
                        </tr>
                        <tr id="producto-row-19">
                            <td>19</td>
                            <td id="nombre-19"></td>
                            <td id="cantidad-19"></td>
                        </tr>
                        <tr id="producto-row-20">
                            <td>20</td>
                            <td id="nombre-20"></td>
                            <td id="cantidad-20"></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>TOTAL</strong></td>
                            <td></td>
                            <td id="totalCantidadProductos">0</td>
                        </tr>
                    </tfoot>
                </table>
                <button type="button" class="btn btn-danger" onclick="abrirModalAuthLimpiar('productos')" style="margin-top: 10px;">Limpiar Productos</button>
            </div>

            <!-- Historial de Delincuentes Capturados -->
            <div class="section-title">Historial de Delincuentes Capturados</div><div class="tabla-delincuentes-container" style="overflow-x:auto; width:100%;">
                <!-- Aquí estaba la tabla antigua de historial de delincuentes capturados. Eliminada para dejar solo la nueva tabla en memoria. -->
                <table id="tablaDelincuentesSimple" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>NOMBRE Y APELLIDO</th>
                            <th>CEDULA</th>
                            <th>EDAD</th>
                            <th>DIRECCIÓN</th>
                            <th>VEHICULO</th>
                            <th>PLACA</th>
                            <th>COLOR</th>
                            <th>FECHA<br>DE CAPTURA</th>
                            <th>DELITO<br>COMETIDO</th>
                            <th>PRODUCTOS</th>
                            <th>CUANTIA</th>
                            <th>N° DE DENUNCIA<br>O RESOLUCIÓN<br>DE JUZGADO</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyDelincuentesSimple">
    <!-- Filas generadas dinámicamente -->
</tbody>
                </table>
            </div>
            

            <div class="section-title">Reporte de Pérdidas Trimestrales</div>
<div>
                <div class="tabla-perdidas-container">
                    <table id="tablaPerdidas" class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th>Casos</th>
                                <th>Pérdidas (B/.)</th>
                                <th>Rango de Fechas</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí se generarán dinámicamente las filas de meses -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td><strong>TOTAL</strong></td>
                                <td id="totalCasosPerdidas">0</td>
                                <td id="totalPerdidasMonto">B/. 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>            
            <div class="mt-30" style="display: flex; flex-wrap: wrap;">
  <div class="tabla-delincuentes-persistentes-container">
    <div style="width: 600px;">
      <h3 class="section-title">Historial de Delincuentes Capturados</h3>

      <table class="table table-bordered" id="tablaDelincuentesPersistentes">
        <thead>
          <tr>
            <th>#</th>
            <th>Nombre y Apellido</th>
            <th>Cédula</th>
            <th>Edad</th>
            <th>Delito Cometido</th>
            <th>Cuantía</th>
            <th>N° Denuncia/Resolución</th>
          </tr>
        </thead>
        <tbody>
            <!-- Filas generadas por JS -->
        </tbody>
    </table>
</div>

                            </tr>



                        </tbody>
                    </table>
                    <div class="mt-10" style="display: flex; justify-content: space-between; align-items: center;">
                        <button id="limpiarDelincuentesBtn" class="btn btn-danger" onclick="limpiarDelincuentesPersistentes()">Limpiar Delincuentes</button>

<!-- Modal de autenticación para limpiar historial (genérico) -->
<div id="modalAuthLimpiar" class="modal" style="display:none !important;position:fixed;z-index:3000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
  <div style="background:#fff;max-width:350px;width:90vw;padding:24px 18px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.22);position:relative;">
    <h5 id="modalAuthLimpiarTitulo" style="margin-top:0;margin-bottom:14px;color:#b30000;font-weight:700;">Autenticación de administrador</h5>
    <div style="margin-bottom:10px;">
      <input id="authUser" type="text" class="form-control" placeholder="Usuario" style="width:100%;margin-bottom:8px;" autocomplete="username">
      <input id="authPass" type="password" class="form-control" placeholder="Contraseña" style="width:100%;margin-bottom:8px;" autocomplete="current-password">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button type="button" class="btn btn-secondary btn-sm" onclick="cerrarModalAuthLimpiar()">Cancelar</button>
      <button type="button" class="btn btn-danger btn-sm" onclick="autenticarYLimpiar()">Aceptar</button>
    </div>
    <div id="authMsg" style="color:#b30000;font-size:13px;margin-top:8px;display:none;"></div>
    <input type="hidden" id="tipoLimpieza" value="">
  </div>
</div>
<script type="text/javascript">
// Limpieza directa de delincuentes persistentes
window.limpiarDelincuentesPersistentes = function() {
  if (confirm('¿Está seguro que desea borrar todo el historial de delincuentes? Esta acción no se puede deshacer.')) {
    localStorage.removeItem('delincuentesPersistentes');
    // Limpieza visual
    var tabla = document.getElementById('tablaDelincuentesPersistentes');
    if (tabla) {
      var tbody = tabla.querySelector('tbody');
      if (tbody) tbody.innerHTML = '';
    }
    if (typeof renderizarTablaHistorialDelincuentes === 'function') {
      renderizarTablaHistorialDelincuentes();
    }
    if (typeof mostrarNotificacion === 'function') {
      mostrarNotificacion('Historial de delincuentes eliminado correctamente.', 'success');
    } else {
      alert('Historial de delincuentes eliminado correctamente.');
    }
  }
};
// Limpieza directa de productos robados
window.limpiarProductosRobados = function() {
  if (confirm('¿Está seguro que desea borrar el Top 20 de productos robados? Esta acción no se puede deshacer.')) {
    // Limpiar almacenamiento y variables globales
    localStorage.removeItem('productosRobados');
    window.productosRobados = [];
    // Si existe, guardar el arreglo vacío en storage
    if (typeof guardarProductosRobados === 'function') {
      guardarProductosRobados();
    }
    var tabla = document.getElementById('tablaProductos');
    if (tabla) {
      var tbody = tabla.querySelector('tbody');
      if (tbody) tbody.innerHTML = '';
      var total = tabla.querySelector('#totalCantidadProductos');
      if (total) total.textContent = '0';
    }
    if (typeof actualizarTablaProductos === 'function') {
      actualizarTablaProductos();
    }
    if (typeof mostrarNotificacion === 'function') {
      mostrarNotificacion('Top 20 de productos robados eliminado correctamente.', 'success');
    } else {
      alert('Top 20 de productos robados eliminado correctamente.');
    }
  }
};

window.abrirModalAuthLimpiar = function(tipo) {
  var modal = document.getElementById('modalAuthLimpiar');
  modal.style.display = 'flex';
  modal.style.setProperty('display', 'flex', 'important');
  document.getElementById('authUser').value = '';
  document.getElementById('authPass').value = '';
  document.getElementById('authMsg').style.display = 'none';
  document.getElementById('tipoLimpieza').value = tipo;
  // Cambia el título del modal según el tipo
  var titulo = 'Autenticación de administrador';
  if (tipo === 'delincuentes') titulo = 'Autenticación para limpiar delincuentes';
  if (tipo === 'productos') titulo = 'Autenticación para limpiar productos robados';
  document.getElementById('modalAuthLimpiarTitulo').textContent = titulo;
  setTimeout(function() {
    document.getElementById('authUser').focus();
  }, 100);
}
window.cerrarModalAuthLimpiar = function() {
  document.getElementById('modalAuthLimpiar').style.display = 'none';
}
window.autenticarYLimpiar = function() {
  var usuario = document.getElementById('authUser').value.trim();
  var password = document.getElementById('authPass').value;
  var tipo = document.getElementById('tipoLimpieza').value;
  var adminUser = 'admin';
  var adminPass = 'admin123';
  var msg = document.getElementById('authMsg');
  if (usuario === adminUser && password === adminPass) {
    if (tipo === 'delincuentes') {
      if (confirm('¿Está seguro que desea borrar todo el historial de delincuentes? Esta acción no se puede deshacer.')) {
        localStorage.removeItem('delincuentes');
        localStorage.removeItem('delincuentesPersistentes');
        if (typeof renderizarTablaHistorialDelincuentes === 'function') {
          renderizarTablaHistorialDelincuentes();
        }
        if (typeof mostrarNotificacion === 'function') {
          mostrarNotificacion('Historial de delincuentes eliminado correctamente.', 'success');
        } else {
          alert('Historial de delincuentes eliminado correctamente.');
        }
        cerrarModalAuthLimpiar();
      }
    } else if (tipo === 'productos') {
      if (confirm('¿Está seguro que desea borrar el Top 20 de productos robados? Esta acción no se puede deshacer.')) {
        localStorage.removeItem('productosRobados');
        // Limpiar visualmente la tabla de productos robados
        if (typeof actualizarTablaProductos === 'function') {
          actualizarTablaProductos();
        } else {
          // Limpieza forzada si la función no existe
          var tabla = document.getElementById('tablaProductos');
          if (tabla) {
            var tbody = tabla.querySelector('tbody');
            if (tbody) tbody.innerHTML = '';
            // Actualizar el total en el pie de tabla, si existe
            var total = tabla.querySelector('#totalCantidadProductos');
            if (total) total.textContent = '0';
          }
        }
        if (typeof mostrarNotificacion === 'function') {
          mostrarNotificacion('Top 20 de productos robados eliminado correctamente.', 'success');
        } else {
          alert('Top 20 de productos robados eliminado correctamente.');
        }
        cerrarModalAuthLimpiar();
      }
    }
  } else {
    msg.textContent = 'Usuario o contraseña incorrectos.';
    msg.style.display = 'block';
    setTimeout(function() {
        if (!password) return;
        var adminUser = 'admin';
        var adminPass = 'admin123';
        if (usuario === adminUser && password === adminPass) {
            if (confirm('¿Está seguro que desea borrar todo el historial de delincuentes? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('delincuentesPersistentes');
                if (typeof renderizarTablaHistorialDelincuentes === 'function') {
                    renderizarTablaHistorialDelincuentes();
                }
                if (typeof mostrarNotificacion === 'function') {
                    mostrarNotificacion('Historial de delincuentes eliminado correctamente.', 'success');
                } else {
                    alert('Historial de delincuentes eliminado correctamente.');
                }
            }
        } else {
            if (typeof mostrarNotificacion === 'function') {
                mostrarNotificacion('Usuario o contraseña incorrectos.', 'error');
            } else {
                alert('Usuario o contraseña incorrectos.');
            }
        }
    }, 1000);
};
</script>
                        <div id="paginacionDelincuentes" class="paginacion-container"></div>
                    </div>
                </div>
                
                <div class="tabla-productos-container">
                    <div style="width: 300px;">
                        <h3 class="section-title">Top 20 Productos y Mercancías Robadas</h3>
                    </div>
                    <table id="tablaProductos" class="table table-bordered">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Producto/Mercancía</th>
                                <th>Cantidad Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 20 filas fijas para el Top 20 -->
                            <tr id="producto-row-1">
                                <td>1</td>
                                <td id="nombre-1"></td>
                                <td id="cantidad-1"></td>
                            </tr>
                            <tr id="producto-row-2">
                                <td>2</td>
                                <td id="nombre-2"></td>
                                <td id="cantidad-2"></td>
                            </tr>
                            <tr id="producto-row-3">
                                <td>3</td>
                                <td id="nombre-3"></td>
                                <td id="cantidad-3"></td>
                            </tr>
                            <tr id="producto-row-4">
                                <td>4</td>
                                <td id="nombre-4"></td>
                                <td id="cantidad-4"></td>
                            </tr>
                            <tr id="producto-row-5">
                                <td>5</td>
                                <td id="nombre-5"></td>
                                <td id="cantidad-5"></td>
                            </tr>
                            <tr id="producto-row-6">
                                <td>6</td>
                                <td id="nombre-6"></td>
                                <td id="cantidad-6"></td>
                            </tr>
                            <tr id="producto-row-7">
                                <td>7</td>
                                <td id="nombre-7"></td>
                                <td id="cantidad-7"></td>
                            </tr>
                            <tr id="producto-row-8">
                                <td>8</td>
                                <td id="nombre-8"></td>
                                <td id="cantidad-8"></td>
                            </tr>
                            <tr id="producto-row-9">
                                <td>9</td>
                                <td id="nombre-9"></td>
                                <td id="cantidad-9"></td>
                            </tr>
                            <tr id="producto-row-10">
                                <td>10</td>
                                <td id="nombre-10"></td>
                                <td id="cantidad-10"></td>
                            </tr>
                            <tr id="producto-row-11">
                                <td>11</td>
                                <td id="nombre-11"></td>
                                <td id="cantidad-11"></td>
                            </tr>
                            <tr id="producto-row-12">
                                <td>12</td>
                                <td id="nombre-12"></td>
                                <td id="cantidad-12"></td>
                            </tr>
                            <tr id="producto-row-13">
                                <td>13</td>
                                <td id="nombre-13"></td>
                                <td id="cantidad-13"></td>
                            </tr>
                            <tr id="producto-row-14">
                                <td>14</td>
                                <td id="nombre-14"></td>
                                <td id="cantidad-14"></td>
                            </tr>
                            <tr id="producto-row-15">
                                <td>15</td>
                                <td id="nombre-15"></td>
                                <td id="cantidad-15"></td>
                            </tr>
                            <tr id="producto-row-16">
                                <td>16</td>
                                <td id="nombre-16"></td>
                                <td id="cantidad-16"></td>
                            </tr>
                            <tr id="producto-row-17">
                                <td>17</td>
                                <td id="nombre-17"></td>
                                <td id="cantidad-17"></td>
                            </tr>
                            <tr id="producto-row-18">
                                <td>18</td>
                                <td id="nombre-18"></td>
                                <td id="cantidad-18"></td>
                            </tr>
                            <tr id="producto-row-19">
                                <td>19</td>
                                <td id="nombre-19"></td>
                                <td id="cantidad-19"></td>
                            </tr>
                            <tr id="producto-row-20">
                                <td>20</td>
                                <td id="nombre-20"></td>
                                <td id="cantidad-20"></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="2">TOTAL</td>
                                <td id="totalCantidadProductos">0</td>
                            </tr>
                        </tfoot>
                    </table>
                    <button id="limpiarProductosBtn" class="btn btn-danger mt-10" onclick="limpiarProductosRobados()">Limpiar Productos</button>
                </div>
            </div>

                        
            <div class="actions-container">
                <button type="button" class="btn btn-primary" onclick="generarPDFPrincipal()">Guardar documento</button>
            </div>

            <div class="modal fade" id="vistaPreviaModal" tabindex="-1" role="dialog" aria-labelledby="vistaPreviaModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="vistaPreviaModalLabel">Vista Previa del Documento</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="pdfViewer" class="pdf-viewer-style"></div> </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                            <button type="button" class="btn btn-success" onclick="imprimirDocumento()">Imprimir</button>
                            <button type="button" class="btn btn-primary" onclick="guardarDocumentoLocal()">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- Sección de estadísticas de seguridad eliminada -->
    </div>

    <!-- Modal para seleccionar tipificación - Diseño moderno -->
    <div class="modal fade" id="modalTipificacion" tabindex="-1" role="dialog" aria-labelledby="modalTipificacionLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <div class="modal-header bg-primary text-white" style="border-bottom: none; padding: 15px 20px;">
                    <h5 class="modal-title" id="modalTipificacionLabel" style="font-weight: 600;">Seleccionar Tipificación</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div class="tipificacion-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px;">
                        <div class="tipificacion-card" data-value="Hurto" style="background: linear-gradient(135deg, #4e73df, #224abe); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-hand-holding-usd" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Hurto</span>
                        </div>
                        <div class="tipificacion-card" data-value="Robo" style="background: linear-gradient(135deg, #e74a3b, #be2617); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-mask" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Robo</span>
                        </div>
                        <div class="tipificacion-card" data-value="Fraude" style="background: linear-gradient(135deg, #f6c23e, #dda20a); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-file-signature" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Fraude</span>
                        </div>
                        <div class="tipificacion-card" data-value="Vandalismo" style="background: linear-gradient(135deg, #1cc88a, #13855c); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-spray-can" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Vandalismo</span>
                        </div>
                        <div class="tipificacion-card" data-value="Extorsión" style="background: linear-gradient(135deg, #36b9cc, #258391); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-money-bill-wave" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Extorsión</span>
                        </div>
                        <div class="tipificacion-card" data-value="Estafa" style="background: linear-gradient(135deg, #6f42c1, #4e2d89); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-user-secret" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Estafa</span>
                        </div>
                        <div class="tipificacion-card" data-value="Secuestro" style="background: linear-gradient(135deg, #5a5c69, #373840); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-user-lock" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Secuestro</span>
                        </div>
                        <div class="tipificacion-card" data-value="Otro" style="background: linear-gradient(135deg, #858796, #60616f); color: white; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;">
                            <i class="fas fa-question-circle" style="font-size: 24px; margin-right: 10px;"></i>
                            <span style="font-weight: 500;">Otro</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependencias externas -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
    // Inicializar jsPDF y AutoTable cuando se carguen
    document.addEventListener('DOMContentLoaded', function() {
        if (window.jspdf && window.jspdf.jsPDF) {
            console.log('jsPDF cargado correctamente');
            // Probar si autoTable está disponible
            try {
                const testDoc = new window.jspdf.jsPDF();
                if (typeof testDoc.autoTable === 'function') {
                    console.log('Plugin AutoTable cargado correctamente');
                } else {
                    console.error('Error: AutoTable no está disponible en el objeto jsPDF');
                }
            } catch (error) {
                console.error('Error al inicializar jsPDF:', error);
            }
        } else {
            console.error('Error: jsPDF no está disponible');
        }
    });
</script>

<!-- Utilidades y helpers -->
<script src="js/simple-chart.js"></script>
<script src="formatear-moneda.js"></script>
<script src="formatear-fecha.js"></script>

<!-- SCRIPTS PRINCIPALES: primero productos-persistentes.js -->
<script src="productos-persistentes.js"></script>
<script src="script.js"></script>
<script src="script_productos.js"></script>
<script src="script_casos.js"></script>
<script src="admin.js"></script>
<script src="sincronizar-tablas.js"></script>

<!-- Funcionalidad de delincuentes -->
<script src="script_delincuentes_nuevo.js"></script>
<script src="tipificacion-selector.js"></script>
<script src="historial-delincuentes.js"></script>
<div id="nuevoDelincuenteModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="nuevoDelincuenteModalLabel">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="nuevoDelincuenteModalLabel">
          <i class="fas fa-user-plus"></i> Registrar Delincuente
        </h5>
        <button type="button" class="close" aria-label="Cerrar" onclick="cerrarModalNuevoDelincuente()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="formNuevoDelincuente" autocomplete="off">
            <div class="form-row-cascade">
                <div class="form-col-cascade">
                    <div class="form-group">
                        <label for="nuevoNombreCompleto">Nombre y Apellido <span style="color:red">*</span></label>
                        <input type="text" class="form-control" id="nuevoNombreCompleto" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevoCedula">Cédula <span style="color:red">*</span></label>
                        <input type="text" class="form-control" id="nuevoCedula" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevoEdad">Edad <span style="color:red">*</span></label>
                        <input type="number" class="form-control" id="nuevoEdad" min="12" max="120" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevoDireccion">Dirección</label>
                        <input type="text" class="form-control" id="nuevoDireccion">
                    </div>
                    <div class="form-group">
                        <label for="nuevoVehiculo">Vehículo</label>
                        <input type="text" class="form-control" id="nuevoVehiculo">
                    </div>
                    <div class="form-group">
                        <label for="nuevoPlaca">Placa</label>
                        <input type="text" class="form-control" id="nuevoPlaca">
                    </div>
                </div>
                <div class="form-col-cascade">
                    <div class="form-group">
                        <label for="nuevoColor">Color</label>
                        <input type="text" class="form-control" id="nuevoColor">
                    </div>
                    <div class="form-group">
                        <label for="nuevoFecha">Fecha de Captura <span style="color:red">*</span></label>
                        <input type="date" class="form-control" id="nuevoFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevoDelito">Delito Cometido <span style="color:red">*</span></label>
                        <input type="text" class="form-control" id="nuevoDelito" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevoProductos">Productos</label>
                        <input type="text" class="form-control" id="nuevoProductos">
                    </div>
                    <div class="form-group">
                        <label for="nuevoCuantia">Cuantía (B/.)</label>
                        <input type="number" class="form-control" id="nuevoCuantia" min="0" step="0.01" inputmode="decimal" placeholder="Ej: 123.45">
                    </div>
                    <div class="form-group">
                        <label for="nuevoDenuncia">N° Denuncia/Resolución</label>
                        <input type="text" class="form-control" id="nuevoDenuncia">
                    </div>
                </div>
            </div>
            <div class="form-group text-right mt-3" style="text-align:right;">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalNuevoDelincuente()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarNuevoDelincuente()">Guardar</button>
            </div>
        </form>
        <style>
            .form-row-cascade {
                display: flex;
                gap: 24px;
                width: 100%;
            }
            .form-col-cascade {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            @media (max-width: 700px) {
                .form-row-cascade {
                    flex-direction: column;
                    gap: 0;
                }
            }
        </style>
      </div>
    </div>
  </div>
</div>



</script>

<!-- Botón para abrir el modal del README/manual de uso -->
<button id="openReadmeModalBtn" style="position:fixed;bottom:20px;right:20px;z-index:2000;background:#3498db;color:#fff;border:none;border-radius:50px;padding:12px 22px;font-size:16px;box-shadow:0 2px 8px rgba(0,0,0,0.18);cursor:pointer;">Manual de uso / Ayuda</button>

<!-- Modal del README/manual de uso -->
<div id="readmeModal" class="modal" style="display:none;position:fixed;z-index:3000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
  <div style="background:#fff;max-width:700px;width:95vw;max-height:90vh;overflow-y:auto;padding:32px 24px;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.22);position:relative;">
    <button id="closeReadmeModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:28px;color:#444;cursor:pointer;">&times;</button>
    <h2 style="margin-top:0;color:#2c3e50;">Manual de Uso y Estado del Sistema</h2>
    <div style="margin-bottom:18px;padding:12px 18px;background:#fff3cd;color:#856404;border-radius:6px;border:1px solid #ffeeba;">
      <b>⚠️ Estado del proyecto: EN DESARROLLO / SUJETO A CAMBIOS</b><br>
      Este sistema está siendo actualizado y mejorado constantemente. Puede contener errores o cambios inesperados. Si eres cliente o usuario, ten en cuenta que la funcionalidad puede variar y algunos módulos pueden estar en revisión.
    </div>
    <h3>¿Qué hace esta aplicación?</h3>
    <ul>
      <li>Registrar casos delictivos por trimestre y empresa.</li>
      <li>Gestionar delincuentes capturados: alta, visualización y almacenamiento local.</li>
      <li>Generar reportes y tablas estadísticas.</li>
      <li>Interfaz amigable y moderna, adaptable para escritorio y dispositivos móviles.</li>
    </ul>
    <h3>¿Cómo se usa?</h3>
    <ol>
      <li><b>Abrir la aplicación:</b> Accede a la URL pública desplegada en Render o abre <code>index.html</code> localmente.</li>
      <li><b>Registrar un caso:</b> Completa los datos de empresa, responsable, fecha y trimestre. Añade los casos delictivos ocurridos, su tipificación, fecha, cuantía y observaciones.</li>
      <li><b>Agregar delincuente capturado:</b> Haz clic en el botón <b>+</b> en la sección correspondiente, completa el formulario y guarda el registro. Los datos se almacenan en el navegador (localStorage) y se muestran en la tabla.</li>
      <li><b>Exportar o visualizar reportes:</b> Usa las opciones de la interfaz para generar reportes o consultar estadísticas.</li>
    </ol>
    <h3>Notas importantes</h3>
    <ul>
      <li><b>Persistencia:</b> Los datos se guardan en el navegador del usuario. Si borras el caché/localStorage, se perderán los registros.</li>
      <li><b>Despliegue:</b> El sitio está publicado en Render. Cada actualización en GitHub se refleja automáticamente en la web.</li>
      <li><b>Estado:</b> El sistema puede presentar errores menores o cambios frecuentes mientras esté en desarrollo activo.</li>
    </ul>
    <h3>Contacto</h3>
    <p>Para reportar errores, sugerencias o solicitar soporte, abre un <a href="https://github.com/SupervisorIT/registro-actividad-criminal/issues" target="_blank">issue en GitHub</a> o contacta al administrador del proyecto.</p>
    <hr>
    <div style="text-align:center;color:#888;font-size:15px;">¡Gracias por tu comprensión y colaboración mientras mejoramos la aplicación!</div>
  </div>
</div>
<script>
// Mostrar y ocultar el modal del README/manual
const openReadmeModalBtn = document.getElementById('openReadmeModalBtn');
const readmeModal = document.getElementById('readmeModal');
const closeReadmeModalBtn = document.getElementById('closeReadmeModalBtn');
if(openReadmeModalBtn && readmeModal && closeReadmeModalBtn) {
  openReadmeModalBtn.onclick = () => { readmeModal.style.display = 'flex'; };
  closeReadmeModalBtn.onclick = () => { readmeModal.style.display = 'none'; };
  readmeModal.onclick = (e) => {
    if (e.target === readmeModal) readmeModal.style.display = 'none';
  };
}
</script>

<script>
// Usamos la función global renderizarTablaDelincuentesSimple definida en script_delincuentes_nuevo.js
// Esta función se encargará de mostrar los delincuentes y gestionar los botones
// Fin refuerzo: solo localStorage

// Eliminar delincuente por índice
function eliminarDelincuentePorIndice(idx) {
    var delincuentes = [];
    if (localStorage.getItem('delincuentes')) {
        try {
            delincuentes = JSON.parse(localStorage.getItem('delincuentes'));
            if (!Array.isArray(delincuentes)) delincuentes = [];
        } catch (e) { delincuentes = []; }
    }
    if (idx >= 0 && idx < delincuentes.length) {
        if (confirm('¿Está seguro que desea eliminar este delincuente?')) {
            delincuentes.splice(idx, 1);
            localStorage.setItem('delincuentes', JSON.stringify(delincuentes));
            window.delincuentes = delincuentes;
            if (typeof actualizarTablaDelincuentes === 'function') actualizarTablaDelincuentes();
            renderizarTablaDelincuentesSimple();
            if (typeof mostrarNotificacion === 'function') {
                mostrarNotificacion('Delincuente eliminado correctamente.', 'success');
            }
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Limpiar tabla de capturados SÓLO al recargar
    window.delincuentes = [];
    renderizarTablaDelincuentesSimple();
    if (typeof actualizarTablaDelincuentes === 'function') {
        var orig = actualizarTablaDelincuentes;
        window.actualizarTablaDelincuentes = function() {
            // Limpiar tabla de capturados SOLO al guardar documento principal
            window.delincuentes = [];
            orig();
            renderizarTablaDelincuentesSimple();
        };
    }
});
</script>
<script>
// Limpia todos los delincuentes capturados y actualiza la tabla visualmente
// Refuerza la limpieza total y la actualización visual de la tabla de delincuentes
function limpiarDelincuentesCapturadosDirecto() {
  if (!confirm('¿Está seguro que desea eliminar TODOS los delincuentes capturados? Esta acción no se puede deshacer.')) return;
  // Borra del almacenamiento principal
  localStorage.removeItem('delincuentes');
  window.delincuentes = [];
  // Borra también el historial de delincuentes
  localStorage.removeItem('delincuentesPersistentes');
  // Limpia manualmente el tbody de la tabla simple
  var tbody = document.getElementById('tbodyDelincuentesSimple');
  if (tbody) tbody.innerHTML = '';
  // Actualiza la tabla simple
  if (typeof renderizarTablaDelincuentesSimple === 'function') {
    renderizarTablaDelincuentesSimple();
  }
  // Actualiza la tabla de historial si existe la función
  if (typeof renderizarTablaHistorialDelincuentes === 'function') {
    renderizarTablaHistorialDelincuentes();
  }
  // Notificación visual
  if (typeof mostrarNotificacion === 'function') {
    mostrarNotificacion('Historial de delincuentes capturados y el historial han sido eliminados correctamente.', 'success');
  } else {
    alert('Historial de delincuentes capturados y el historial han sido eliminados correctamente.');
  }
}
// Fin limpieza total de capturados e historial
</script>
<script>
    function autenticarYLimpiar(tipo) {
      // Puedes adaptar esto para usar tu modal, aquí ejemplo con prompt:
      var usuario = prompt('Ingrese el usuario de administrador:');
      if (!usuario) return;
      var password = prompt('Ingrese la contraseña de administrador:');
      if (!password) return;
      var adminUser = 'admin';
      var adminPass = 'admin123';
    
      if (usuario === adminUser && password === adminPass) {
        if (tipo === 'delincuentes') {
          if (confirm('¿Está seguro que desea borrar todo el historial de delincuentes? Esta acción no se puede deshacer.')) {
            localStorage.removeItem('delincuentes');
            localStorage.removeItem('delincuentesPersistentes');
            if (typeof renderizarTablaHistorialDelincuentes === 'function') {
              renderizarTablaHistorialDelincuentes();
            }
            if (typeof mostrarNotificacion === 'function') {
              mostrarNotificacion('Historial de delincuentes eliminado correctamente.', 'success');
            } else {
              alert('Historial de delincuentes eliminado correctamente.');
            }
          }
        } else if (tipo === 'productos') {
          if (confirm('¿Está seguro que desea borrar el Top 20 de productos robados? Esta acción no se puede deshacer.')) {
            localStorage.removeItem('productosRobados');
            if (typeof actualizarTablaProductos === 'function') {
              actualizarTablaProductos();
            }
            if (typeof mostrarNotificacion === 'function') {
              mostrarNotificacion('Top 20 de productos robados eliminado correctamente.', 'success');
            } else {
              alert('Top 20 de productos robados eliminado correctamente.');
            }
          }
        }
      } else {
        if (typeof mostrarNotificacion === 'function') {
          mostrarNotificacion('Usuario o contraseña incorrectos.', 'error');
        } else {
          alert('Usuario o contraseña incorrectos.');
        }
      }
    }
    </script>
<script type="text/javascript">
window.limpiarDelincuentesPersistentes = function() {
  var tabla = document.getElementById('tablaDelincuentesPersistentes');
  if (tabla) {
    var tbody = tabla.querySelector('tbody');
    if (tbody) tbody.innerHTML = '';
  }
  localStorage.removeItem('delincuentes');
  localStorage.removeItem('delincuentesPersistentes');
};
window.limpiarProductosRobados = function() {
  var tabla = document.getElementById('tablaProductos');
  if (tabla) {
    // Limpiar solo los datos de las filas, no la estructura
    for (let i = 1; i <= 20; i++) {
      var nombre = document.getElementById('nombre-' + i);
      var cantidad = document.getElementById('cantidad-' + i);
      if (nombre) nombre.textContent = '';
      if (cantidad) cantidad.textContent = '';
    }
    var total = tabla.querySelector('#totalCantidadProductos');
    if (total) total.textContent = '0';
  }
  window.productosRobados = [];
  localStorage.removeItem('productosRobados');
  if (typeof guardarProductosRobados === 'function') {
    guardarProductosRobados();
  }
  if (typeof mostrarNotificacion === 'function') {
    mostrarNotificacion('Top 20 de productos robados eliminado correctamente.', 'success');
  } else {
    alert('Top 20 de productos robados eliminado correctamente.');
  }
};
</script>
</body>
</html>